<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ストループ課題</title>
  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.0" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2" defer></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 2em;
    }
    #jspsych-target {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js" defer></script>

  <script defer>
    window.onload = function () {
      // ✅ Firebase 設定（あなたのプロジェクト情報に置き換えてください）
      const firebaseConfig = {
        apiKey: "AIzaSyDnZtQ02sSWCajHWkAgoik1JEIUfxP011A",
        authDomain: "github-survey.firebaseapp.com",
        databaseURL: "https://github-survey-default-rtdb.firebaseio.com",
        projectId: "github-survey",
        storageBucket: "github-survey.appspot.com",
        messagingSenderId: "736836641989",
        appId: "1:736836641989:web:5fab88b6fc1dd0f519fcac"
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const jsPsych = initJsPsych({
        display_element: 'jspsych-target',
        on_finish: function () {
          const filteredData = jsPsych.data.get().filter({trial_type: 'html-keyboard-response'}).values();

          const results = filteredData.map(trial => ({
            participant_id: trial.participant_id || null,
            word: trial.word || null,
            color: trial.color || null,
            congruent: trial.congruent || null,
            rt: trial.rt || null,
            key_press: trial.key_press || null
          }));

          if (results.length > 0) {
            const ref = database.ref('stroop_results').push();
            ref.set(results)
              .then(() => console.log("データが保存されました"))
              .catch((err) => console.error("保存エラー:", err));
          }

          jsPsych.data.displayData(); // デバッグ用
        }
      });

      const participantID = jsPsych.randomization.randomID(8);
      const timeline = [];

      // 最初の指示
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'ストループ課題へようこそ。<br><br>スペースキーで開始します。',
        choices: [' ']
      });

      // 単語と色の設定
      const words = ['赤', '青', '緑'];
      const colors = ['red', 'blue', 'green'];
      const colorMap = { red: '赤', blue: '青', green: '緑' };

      // 試行作成
      let trials = [];
      for (let rep = 0; rep < 2; rep++) {
        for (let word of words) {
          for (let color of colors) {
            trials.push({
              type: jsPsychHtmlKeyboardResponse,
              stimulus: `<p style="font-size:48px; color:${color};">${word}</p>`,
              choices: ['r', 'g', 'b'],
              data: {
                participant_id: participantID,
                word: word,
                color: color,
                congruent: word === colorMap[color] ? 'congruent' : 'incongruent'
              },
              trial_duration: 2000
            });
          }
        }
      }

      timeline.push(...jsPsych.randomization.shuffle(trials));

      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '終了しました。ご協力ありがとうございました。',
        choices: 'NO_KEYS',
        trial_duration: 2000
      });

      // 実験開始
      jsPsych.run(timeline);
    };
  </script>
</body>
</html>
