<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ストループ課題</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 2em; }
    #jspsych-target { margin-top: 30px; }
  </style>
</head>
<body>
  <!-- 添加一个明确的容器用于jsPsych -->
  <div id="jspsych-target"></div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
  
  <script>
    // 确保DOM完全加载后再初始化
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Firebase 設定 - ご自身の設定情報に置き換えてください
       //  const firebaseConfig = {
        // apiKey: "AIzaSyCwEl0R1HQ2nFLViWs7w5d0qu3QiV3TLc0",
  // authDomain: "xie-survey.firebaseapp.com",
 //  databaseURL: "https://xie-survey-default-rtdb.firebaseio.com",
  // projectId: "xie-survey",
  // storageBucket: "xie-survey.firebasestorage.app",
 //  messagingSenderId: "1055255116763",
  // appId: "1:1055255116763:web:c6356ee608630e5f4285fe"
     const firebaseConfig = {
  apiKey: "AIzaSyDnZtQ02sSWCajHWkAgoik1JEIUfxP011A",
  authDomain: "github-survey.firebaseapp.com",
  databaseURL: "https://github-survey-default-rtdb.firebaseio.com",
  projectId: "github-survey",
  storageBucket: "github-survey.firebasestorage.app",
  messagingSenderId: "736836641989",
  appId: "1:736836641989:web:5fab88b6fc1dd0f519fcac",
  measurementId: "G-C4VC9BN0P7"   
        };

        // Firebase の初期化
        firebase.initializeApp(firebaseConfig);
        
        // データベース参照を取得
        const database = firebase.database();

        // 确保jsPsych-html-keyboard-response插件已加载
        if (typeof jsPsychHtmlKeyboardResponse === 'undefined') {
          throw new Error("jsPsych HTML Keyboard Response plugin is not loaded");
        }

        const jsPsych = initJsPsych({
          display_element: 'jspsych-target',  // 指定一个明确的目标元素
          on_finish: function() {
            try {
              // 正しい方法でデータを取得
              const filteredData = jsPsych.data.get().filter({trial_type: 'html-keyboard-response'}).values();
              
              // デバッグ出力
              console.log("フィルタリングされたデータ:", filteredData);
              
              // 結果配列の作成 - undefinedの値を処理
              const results = [];
              for (let i = 0; i < filteredData.length; i++) {
                const trial = filteredData[i];
                if (trial.participant_id) { // 有効なデータのみ追加
                  // undefinedの値をnullに置き換える
                  const cleanTrial = {
                    participant_id: trial.participant_id || null,
                    word: trial.word || null,
                    color: trial.color || null,
                    congruent: trial.congruent || null,
                    rt: trial.rt || null,
                    // key_pressが存在しない場合はnullを使用
                    key_press: trial.key_press !== undefined ? trial.key_press : null
                  };
                  results.push(cleanTrial);
                }
              }
              
              console.log("処理されたデータ:", results);
              
              // データが存在する場合のみFirebaseに保存
              if (results.length > 0) {
                // Firebaseにデータを保存
                const stroopRef = database.ref('stroop_results');
                const newSessionRef = stroopRef.push();
                
                newSessionRef.set(results)
                  .then(() => {
                    console.log("データが正常に保存されました");
                  })
                  .catch((error) => {
                    console.error("データの保存中にエラーが発生しました:", error);
                  });
              } else {
                console.warn("保存するデータがありません");
              }
            } catch (error) {
              console.error("データ処理中にエラーが発生しました:", error);
            }

            jsPsych.data.displayData(); // デバッグ用表示
          }
        });

        const participantID = jsPsych.randomization.randomID(8);
        const timeline = [];

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: 'ストループ課題へようこそ。<br><br>スペースキーで開始します。',
          choices: [' ']
        });

        const words = ['赤', '青', '緑'];
        const colors = ['red', 'blue', 'green'];

        function getJapaneseColorName(color) {
          return {red: '赤', blue: '青', green: '緑'}[color];
        }

        let trials = [];
        for (let rep = 0; rep < 2; rep++) {
          for (let word of words) {
            for (let color of colors) {
              trials.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p style="font-size:48px; color:${color};">${word}</p>`,
                choices: ['r', 'g', 'b'],
                data: {
                  participant_id: participantID,
                  word: word,
                  color: color,
                  congruent: word === getJapaneseColorName(color) ? 'congruent' : 'incongruent'
                },
                trial_duration: 2000
              });
            }
          }
        }

        timeline.push(...jsPsych.randomization.shuffle(trials));

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '終了しました。ご協力ありがとうございました。',
          choices: 'NO_KEYS',
          trial_duration: 2000
        });

        // 开始实验
        jsPsych.run(timeline);
        
      } catch (error) {
        console.error("初期化中にエラーが発生しました:", error);
        // 在页面上显示错误信息
        document.body.innerHTML += `<div style="color:red; margin-top:20px;">エラーが発生しました: ${error.message}</div>`;
      }
    });
  </script>
</body>
</html>
