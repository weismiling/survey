<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—èª²é¡Œ</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 2em; background-color: #f5f5f5; }
    #jspsych-target { margin-top: 30px; }
    .intro-page { font-size: 18px; margin-top: 20px; }
    .btn-start { padding: 10px 20px; font-size: 18px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
  </style>
</head>
<body>

  <!-- äºˆå‚™ãƒšãƒ¼ã‚¸ -->
  <div id="intro-page">
    <h1>ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—èª²é¡Œã¸ã‚ˆã†ã“ãï¼</h1>
    <p class="intro-page">ã“ã®å®Ÿé¨“ã¯ã€è‰²ã¨å˜èªã®åå¿œæ™‚é–“ã‚’æ¸¬å®šã™ã‚‹ã‚‚ã®ã§ã™ã€‚å®Ÿé¨“ã«å‚åŠ ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿åé›†ã«å”åŠ›ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚</p>
    <p class="intro-page">å®Ÿé¨“ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®ç°¡å˜ãªè³ªå•ã«ãŠç­”ãˆãã ã•ã„ã€‚</p>

    <form id="consent-form">
      <label>
        <input type="checkbox" id="consent-checkbox" required>
        ç§ã¯ã“ã®å®Ÿé¨“ã«å‚åŠ ã—ã€æä¾›ã•ã‚ŒãŸæƒ…å ±ãŒåé›†ã•ã‚Œã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™ã€‚
      </label>
      <br><br>
      <button type="submit" class="btn-start" id="start-btn" disabled>å®Ÿé¨“é–‹å§‹</button>
    </form>
  </div>

  <!-- jsPsych å®Ÿé¨“ -->
  <div id="jspsych-target" style="display:none;"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>

  <script>
    // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    document.getElementById('consent-checkbox').addEventListener('change', function () {
      document.getElementById('start-btn').disabled = !this.checked;
    });

    // åˆæœŸåŒ–
    document.getElementById('consent-form').addEventListener('submit', function (e) {
      e.preventDefault();
      document.getElementById('intro-page').style.display = 'none';
      document.getElementById('jspsych-target').style.display = 'block';
      startExperiment();
    });

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDnZtQ02sSWCajHWkAgoik1JEIUfxP011A",
      authDomain: "github-survey.firebaseapp.com",
      databaseURL: "https://github-survey-default-rtdb.firebaseio.com",
      projectId: "github-survey",
      storageBucket: "github-survey.appspot.com",
      messagingSenderId: "736836641989",
      appId: "1:736836641989:web:5fab88b6fc1dd0f519fcac"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function startExperiment() {
      const jsPsych = initJsPsych({
        display_element: 'jspsych-target',
        on_finish: function () {
          const data = jsPsych.data.get().filter({ trial_type: 'html-keyboard-response' }).values();
          const participantID = jsPsych.data.get().values()[0].participant_id || "unknown";

          const filtered = data.map(trial => ({
            participant_id: trial.participant_id || participantID,
            word: trial.word || null,
            color: trial.color || null,
            congruent: trial.congruent || null,
            rt: trial.rt || null,
            key_press: trial.key_press !== undefined ? trial.key_press : null
          }));

          if (filtered.length > 0) {
            const ref = database.ref('stroop_results').push();
            ref.set(filtered).then(() => {
              console.log("ãƒ‡ãƒ¼ã‚¿é€ä¿¡æˆåŠŸï¼");
            }).catch((error) => {
              console.error("ãƒ‡ãƒ¼ã‚¿é€ä¿¡å¤±æ•—:", error);
            });
          }

          jsPsych.endExperiment(`
            <h2>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</h2>
            <p>ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚</p>
          `);
        }
      });

      const participantID = jsPsych.randomization.randomID(8);
      const timeline = [];

      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—èª²é¡Œã¸ã‚ˆã†ã“ãã€‚<br><br>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§é–‹å§‹ã—ã¾ã™ã€‚',
        choices: [' ']
      });

      const words = ['èµ¤', 'é’', 'ç·‘'];
      const colors = ['red', 'blue', 'green'];

      function getJapaneseColorName(color) {
        return { red: 'èµ¤', blue: 'é’', green: 'ç·‘' }[color];
      }

      let trials = [];
      for (let rep = 0; rep < 2; rep++) {
        for (let word of words) {
          for (let color of colors) {
            trials.push({
              type: jsPsychHtmlKeyboardResponse,
              stimulus: `<p style="font-size:48px; color:${color};">${word}</p>`,
              choices: ['r', 'g', 'b'],
              data: {
                word: word,
                color: color,
                congruent: word === getJapaneseColorName(color) ? 'congruent' : 'incongruent'
              },
              response_ends_trial: true
            });
          }
        }
      }

      // ğŸ”§ ä¿®æ­£ï¼šã™ã¹ã¦ã® trial ã« participant_id ã‚’è¿½åŠ 
      trials = trials.map(trial => {
        trial.data.participant_id = participantID;
        return trial;
      });

      timeline.push(...jsPsych.randomization.shuffle(trials));

      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'çµ‚äº†ã—ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚',
        choices: 'NO_KEYS',
        trial_duration: 2000
      });

      jsPsych.run(timeline);
    }
  </script>
</body>
</html>
