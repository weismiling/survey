<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ストループ課題</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 2em; background-color: #f5f5f5; }
    #jspsych-target { margin-top: 30px; }
    .intro-page { font-size: 18px; margin-top: 20px; }
    .btn-start { padding: 10px 20px; font-size: 18px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
    .btn-start:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

  <!-- 预设问卷前置页面 -->
  <div id="intro-page">
    <h1>ストループ課題へようこそ！</h1>
    <p class="intro-page">この実験は、色と単語の反応時間を測定するものです。実験に参加することで、データ収集に協力することになります。</p>
    <p class="intro-page">実験を開始する前に、以下の簡単な質問にお答えください。</p>

    <form id="consent-form">
      <label>
        <input type="checkbox" id="consent-checkbox">
        私はこの実験に参加し、提供された情報が収集されることに同意します。
      </label>
      <br><br>
      <button type="submit" class="btn-start" id="start-btn" disabled>実験開始</button>
    </form>
  </div>

  <!-- jsPsych 実験 -->
  <div id="jspsych-target" style="display:none;"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>

  <script>
    // 初期化部分：等待用户同意后启动实验
    document.getElementById('consent-checkbox').addEventListener('change', function () {
      const startButton = document.getElementById('start-btn');
      // チェックボックスがチェックされた場合にボタンを有効化
      startButton.disabled = !this.checked;
    });

    // 同意フォーム送信後に実験を開始
    document.getElementById('consent-form').addEventListener('submit', function (e) {
      e.preventDefault();

      if (document.getElementById('consent-checkbox').checked) {
        document.getElementById('intro-page').style.display = 'none';  // 隠す前置页面
        document.getElementById('jspsych-target').style.display = 'block';  // 表示实验页面
        startExperiment();  // 启动实验
      }
    });

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyDnZtQ02sSWCajHWkAgoik1JEIUfxP011A",
      authDomain: "github-survey.firebaseapp.com",
      databaseURL: "https://github-survey-default-rtdb.firebaseio.com",
      projectId: "github-survey",
      storageBucket: "github-survey.appspot.com",
      messagingSenderId: "736836641989",
      appId: "1:736836641989:web:5fab88b6fc1dd0f519fcac"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function startExperiment() {
      // ✅ jsPsych 初期化
      const jsPsych = initJsPsych({
        display_element: 'jspsych-target',
        on_finish: function () {
          const data = jsPsych.data.get().filter({ trial_type: 'html-keyboard-response' }).values();
          
          const participantID = jsPsych.data.get().values()[0].participant_id || "unknown";
          const filtered = data.map(trial => ({
            participant_id: participantID,
            word: trial.word || null,
            color: trial.color || null,
            congruent: trial.congruent || null,
            rt: trial.rt || null,
            key_press: trial.key_press !== undefined ? trial.key_press : null
          }));

          if (filtered.length > 0) {
            const ref = database.ref('stroop_results').push();
            ref.set(filtered).then(() => {
              console.log("データ送信成功！");
            }).catch((error) => {
              console.error("データ送信失敗:", error);
            });
          }

          jsPsych.endExperiment(`
            <h2>ご協力ありがとうございました！</h2>
            <p>データは正常に送信されました。</p>
          `);
        }
      });

      const participantID = jsPsych.randomization.randomID(8);
      const timeline = [];

      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'ストループ課題へようこそ。<br><br>スペースキーで開始します。',
        choices: [' ']
      });

      const words = ['赤', '青', '緑'];
      const colors = ['red', 'blue', 'green'];

      function getJapaneseColorName(color) {
        return { red: '赤', blue: '青', green: '緑' }[color];
      }

      let trials = [];
      for (let rep = 0; rep < 2; rep++) {
        for (let word of words) {
          for (let color of colors) {
            trials.push({
              type: jsPsychHtmlKeyboardResponse,
              stimulus: `<p style="font-size:48px; color:${color};">${word}</p>`,
              choices: ['r', 'g', 'b'],
              data: {
                participant_id: participantID,
                word: word,
                color: color,
                congruent: word === getJapaneseColorName(color) ? 'congruent' : 'incongruent'
              },
              response_ends_trial: true
            });
          }
        }
      }

      timeline.push(...jsPsych.randomization.shuffle(trials));

      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '終了しました。ご協力ありがとうございました。',
        choices: 'NO_KEYS',
        trial_duration: 2000
      });

      jsPsych.run(timeline);
    }
  </script>
</body>
</html>
