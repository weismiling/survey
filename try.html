<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ストループ課題</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 2em; }
    #jspsych-target { margin-top: 30px; }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>

  <script>
    window.onload = function() {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyDnZtQ02sSWCajHWkAgoik1JEIUfxP011A",
          authDomain: "github-survey.firebaseapp.com",
          databaseURL: "https://github-survey-default-rtdb.firebaseio.com",
          projectId: "github-survey",
          storageBucket: "github-survey.appspot.com",
          messagingSenderId: "736836641989",
          appId: "1:736836641989:web:5fab88b6fc1dd0f519fcac"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const jsPsych = initJsPsych({
          display_element: 'jspsych-target',
          on_finish: function() {
            const data = jsPsych.data.get().filter({trial_type: 'html-keyboard-response'}).values();

            const participant_id = data[0]?.participant_id || jsPsych.randomization.randomID(8);

            const results = data.map(d => ({
              participant_id: participant_id,
              word: d.word || null,
              color: d.color || null,
              congruent: d.congruent || null,
              rt: d.rt || null,
              key_press: d.key_press || null
            }));

            if (results.length > 0) {
              const ref = database.ref('stroop_results').push();
              ref.set(results)
                .then(() => console.log("データ送信成功"))
                .catch(err => console.error("送信失敗", err));
            }

            jsPsych.data.displayData();
          }
        });

        const participantID = jsPsych.randomization.randomID(8);
        const timeline = [];

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: 'ストループ課題へようこそ。<br><br>スペースキーで開始します。',
          choices: [' ']
        });

        const words = ['赤', '青', '緑'];
        const colors = ['red', 'blue', 'green'];
        const getJapaneseColorName = c => ({red: '赤', blue: '青', green: '緑'})[c];

        let trials = [];
        for (let rep = 0; rep < 2; rep++) {
          for (let word of words) {
            for (let color of colors) {
              trials.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p style="font-size:48px; color:${color};">${word}</p>`,
                choices: ['r', 'g', 'b'],
                data: {
                  participant_id: participantID,
                  word: word,
                  color: color,
                  congruent: word === getJapaneseColorName(color) ? 'congruent' : 'incongruent'
                },
                trial_duration: 2000
              });
            }
          }
        }

        timeline.push(...jsPsych.randomization.shuffle(trials));

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '終了しました。ご協力ありがとうございました。',
          choices: "NO_KEYS",
          trial_duration: 2000
        });

        jsPsych.run(timeline);
      } catch (e) {
        console.error("エラー:", e);
        document.body.innerHTML += `<div style="color:red;">エラーが発生しました: ${e.message}</div>`;
      }
    };
  </script>
</body>
</html>
